# Practical 1: Developing and deploying an open-source medical genomic bioinformatic workflow

- use the Nextflow DSL to run parallel, scalable analyses on High Performance Computing and cloud computing facilities
- efficient use of github for open-source development and Continuous Integration automated tests
- reliance on conda and docker/singularity containers for reproducibility

## Prerequisites
**Case 1 You are on an INSA machine:**
<ol>
<li> Create a conda environment eg. 
    
`conda create -n nf_tp1`

<li> Install Nextflow through the following command: 
        
`conda install -c bioconda nextflow`

<li> Install Singularity such as:

`conda install -c conda-forge singularity`
</ol>


**Case 2 You are working locally on your own Linux machine (or on a Linux VM):**
<ol>
<li> Check your version of java:

`java version`

If you don't have java or if you have a version lower than 8 please run the following command: `sudo apt-get install openjdk-8-jre`

<li> If you have anaconda or (miniconda) continue the setup process following the instructions given for the first case.
    Otherwise install miniconda:
    <ol>
    <li>Download miniconda:

`wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh`
    <li> Install miniconda eg. 
`bash /home/username/miniconda.sh`
    <li> Export the path eg. `export PATH=$PATH:/miniconda3/bin` (or edit the .bashrc file)
    <li> Init conda: `conda init`
    <li> Restart a new terminal and continue the setup process with the instructions given for the first case.
    </ol>
</ol>

**Case 3 Any of these solutions work:**
Follow the official instructions:
- [Nextflow installed](https://www.nextflow.io/docs/latest/getstarted.html)

**In ANY case:**
Have a look at the [NextFlow tutorial](https://seqera.io/training/). 

*What is [singularity](https://sylabs.io/guides/3.6/user-guide/)?*

## How to use the available ressources?

**Question 1:** Create a working directory and clone inside the github repository https://github.com/IARCbioinfo/data_test.git. A data test set is particulary useful to develop bioinformatics tools. Can you explain why? 

**Question 2:** Browse the repository https://github.com/IARCbioinfo/RNAseq-nf and run the pipeline.

**Hints:** 
- Nextflow allow execution of a pipeline directly from a GitHub repository.
- To run a pipeline you need to call the right computational environment.
- What are the mandatory parameters?
- What optional parameters can be useful?

*Kahoo questions:

- Why is there any instruction in the singularity files to install packages?
- From which chromosome the fastq files come from?
- Why there is two fastq files associated to each individual?
- What is a bed file?
- What is missing in the data_test repository? A readme file ^^*

**Question 3:** While the pipeline running ...

Try create your first nexflow script call "HelloWorld.nf". This sctipt should contain:
- A parameter named greeting eaquivalent to "Hello world!";
- A queue channel built using the previous parameter;
- A process that include:
    + A directive allowing to print the outputs return by the command "echo";
    + An input declaration block built from the queue channel;
    + An output declaration block that create a channel from the outputs of echo command;
    + A bash process that should "echo" the value from the input channel.

Run this script with the command line: `nextflow run HelloWorld.nf`. 

**Expected output:**

`[55/73b81a] process > SayHello (1) [100%] 1 of 1 ✔
Hello world!

Hello world!`

**Hints:**
- A directive is state inside a process.
- An output should follow the pattern:
`output: <output qualifier> <output name> into <target channel>[,channel,..]`.
- The output qualifier to catch the outputs from the command `echo` is `stdout`.

*Kahoo questions:
- How to print "Bonjour le monde!* without modifying the script?
- A queue channel as the following specificities?*

**Expected outputs:**

`[4b/a37d19] process > fastqc_pretrim (NA06984_T_RG1) [100%] 3 of 3 ✔
[4a/5fe731] process > alignment (NA06984_T_RG1)      [100%] 3 of 3 ✔
[63/12a97e] process > RSEQC (NA06984_T_RG1)          [100%] 3 of 3 ✔
[-        ] process > RSEQCsplit                     -
[a4/1afaec] process > quantification (NA06984_T_RG1) [100%] 3 of 3 ✔
[52/de307e] process > multiqc_pretrim (all)          [100%] 1 of 1 ✔
[97/96c127] process > multiqc_posttrim (all)         [100%] 1 of 1 ✔
Completed at: 19-Nov-2020 09:08:47
Duration    : 15m 13s
CPU hours   : 0.1
Succeeded   : 14`

**Question 3:** Explore the outputs:
- Find two ways to access the pre-trimming HTML reports generated by FastQC.
- Which are the files generated by the second process named 'alignment'? 
- Which are the files generated by the process named 'quantification'? Open them and give your interpretations.
- What is the name of the gene corresponding to the Ensembl gene ID "ENSG00000141510.11"? What are its functions?

## Create your own pipeline
You will create a pipeline aiming at mapping RNAseq paired reads to a reference genome.

**Question 4:** [Salmon](https://salmon.readthedocs.io/en/latest/) will be used as a pseudo aligner tool.
<ol>
<li> Create an `environment.yml` file specifying that salmon is requested. 
<li> In order to used the command `-profile conda` you should create a `nextflow.config` file.
</ol>

**Hints:**
- Have a glance at the corresponding files on the [Iarc_RNAseq_Github_repository](https://github.com/IARCbioinfo/RNAseq-nf)

*Kahoo questions:

- What is the main difference between an aligner (like STAR) and a speudo aligne (like Salmon or Kallisto)
- Why indexing the reference genome (or transcriptome) is essential?*

**Question 5:** Create a nextflow script allowing to index the reference genome with Salmon.
- Use the directive `publishDir` to copy the outfiles in a folder named `INDEX`;
- In the input declarative block targets the reference genome file;
- An output declarative block should create a channel to get the outputs from salmon.

**Hints:**
- The reference genome is in "data_test/REF/ctat_genome_lib_build_dir_TP53/ref_genome.fa";
- Have a glance at [publishDir](https://www.nextflow.io/docs/latest/process.html#publishdir) documentation.
- The qualifier of the output channel should be `file` or `path`.

*Kahoo questions:
- What is the difference between a queue channel and a value channel or a parameter?*

**Question 6:** Create a nextflow script to quantify the sets of paired read using salmon:
- Continue the previous script;
- The output from the indexing process must be convert into a parameter;
- Create a directive specifying the number of cpus to use;
- The outputs files should be in a directory named `Alignments`

**Expected outputs:**
`N E X T F L O W  ~  version 20.10.0
Launching `alignment_transcriptome.nf` [magical_franklin] - revision: 53a3dd9b56
executor >  local (4)
[46/7bdec3] process > IndexRef (1) [100%] 1 of 1 ✔
[93/3f625d] process > Mapping (1)  [100%] 3 of 3 ✔
`
**Hints:**
- A type of channel is named fromFilePairs :)!
- Salmon has an optional argument which is `--threads`.

**Question 7:** How many reads have been mapped for the sample NA06984_T_RG1?

**Question Bonus:**
Do you have a better idea than creating a prameter targetting the index folder? How can the output channel from the indexing process, can be used in order to get the quantifycation **for each** sample?


*Kahoo questions:
- How many time will the quantifying process be run ?
- Running a nextflow script what does the option `-resume` show?*

